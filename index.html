<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TWZOO Sudoku</title>
  <meta name="theme-color" content="#ffffff" />
  <!-- 若根目錄有 favicon.png 或 Favicon.png，瀏覽器會自動採用。沒有也沒關係。 -->
  <link rel="icon" href="favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="favicon.png" />
  <style>
    :root{
      --bg:#fffafc; --ink:#2d2a32; --muted:#8b8b99; --brand:#6aa5ff; --accent:#ffd166;
      --cell:#fff; --cell-alt:#fff3f8; --given:#f1f5ff; --error:#ffe2e2; --ok:#e7ffe7;
      --grid:#f3b3cc; --subgrid:#e784a6; --shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", Arial, sans-serif; background:var(--bg); color:var(--ink);}    
    header{padding:14px 16px; border-bottom:1px solid #f0e3ea; background:#fff; position:sticky; top:0; z-index:2}
    .head{display:flex; flex-direction:column; gap:6px}
    .title{font-weight:700; letter-spacing:.2px; color: var(--subgrid); font-size:20px}
    .subtitle{color:var(--muted); font-weight:500; font-size:13px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid #e8d3df; color:#6b6b77; background:#fff}
    button{border:1.5px solid #e8d3df; background:#fff; padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:600}
    button:hover{background:#fff6fb}
    .primary{background:var(--brand); color:#fff; border-color:var(--brand)}

    main{max-width:720px; margin:0 auto; padding:18px}

    /* Board wrapper & base */
    .board-wrap{background:#fff;border:2px solid #f0e3ea; border-radius:18px; padding:16px; box-shadow:var(--shadow)}
    .board{border:2.5px solid var(--subgrid); border-radius:12px; overflow:hidden}
    .cell{border:1.5px solid var(--grid); background:var(--cell); display:flex; align-items:center; justify-content:center; position:relative; user-select:none}
    .cell.alt{background:var(--cell-alt)}
    .cell.given{background:var(--given)}
    .cell.error{background:var(--error)}
    .cell.ok{background:var(--ok)}
    .cell.hl{box-shadow:0 0 0 3px var(--accent) inset; position:relative}
    .cell img{max-width:80%; max-height:80%; pointer-events:none}
    .cell.thick-right{border-right:2.5px solid var(--subgrid)}
    .cell.thick-bottom{border-bottom:2.5px solid var(--subgrid)}

    /* Picker (enlarged) */
    .picker{position:absolute; z-index:5; display:grid; grid-template-columns:repeat(3,72px); gap:8px; padding:12px; background:#fff; border:2px solid #f0e3ea; border-radius:14px; box-shadow:var(--shadow)}
    .pick{width:72px; height:72px; display:flex; align-items:center; justify-content:center; border:1.5px dashed #e4c1d4; border-radius:12px; cursor:pointer; background:var(--cell-alt)}
    .pick img{max-width:92%; max-height:92%}
    .hidden{display:none}

    .hint{margin:10px 4px; color:var(--muted); font-size:12px}

    /* Error overlay */
    #err{position:fixed; left:0; right:0; top:0; background:#ffeaea; color:#b00020; padding:10px 14px; border-bottom:2px solid #ffb3b3; font-size:12px; display:none; z-index:99}
  </style>
</head>
<body>
  <div id="err"></div>
  <header>
    <div class="head">
      <div class="title">TWZOO Sudoku</div>
      <div class="subtitle">點選空格會跳出選單、雙擊格子清除</div>
      <div class="actions">
        <span id="status" class="pill">就緒</span>
        <button id="btnCheck" class="primary">檢查</button>
        <button id="btnReset">重置到題目</button>
      </div>
    </div>
  </header>

  <main>
    <section class="board-wrap">
      <!-- 行內樣式強制 9 欄 grid，避免整盤變長條 -->
      <div id="board" class="board" aria-label="9x9 board"
           style="display:grid;grid-template-columns:repeat(9,minmax(34px,1fr));gap:0"></div>
    </section>
    <div class="hint">提示：鍵盤 1–9 也可填入、Backspace 清除</div>
  </main>

  <!-- floating 3x3 image picker -->
  <div id="picker" class="picker hidden" role="dialog" aria-label="選擇圖像"></div>

<script>
'use strict';
(function(){
  // ===== Error guard =====
  var errBar = document.getElementById('err');
  window.addEventListener('error', function(e){
    errBar.textContent = '腳本錯誤：' + (e.message || e.error);
    errBar.style.display='block';
    console.error(e.error || e.message);
  });

  // ===== Images =====
  function numberSVG(n, bg){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 200 200\">' +
      '<defs><filter id=\"s\" x=\"-20%\" y=\"-20%\" width=\"140%\" height=\"140%\"><feDropShadow dx=\"0\" dy=\"6\" stdDeviation=\"6\" flood-opacity=\".18\"/></filter></defs>' +
      '<circle cx=\"100\" cy=\"100\" r=\"82\" fill=\"'+bg+'\" filter=\"url(#s)\"/>' +
      '<text x=\"50%\" y=\"54%\" text-anchor=\"middle\" dominant-baseline=\"middle\" font-size=\"120\" font-family=\"system-ui, sans-serif\" fill=\"white\" font-weight=\"800\">'+n+'</text>' +
      '</svg>'
    );
  }
  var demoBG = ['#78a8ff','#ffa3a3','#ffc658','#9fe87f','#b996ff','#ff86d3','#7ad8ff','#ffb36a','#83e6d6'];
  var IMAGES = [];
  for (var d=0; d<9; d++) IMAGES.push(numberSVG(d+1, demoBG[d]));
  function autoLoadFromImagesFolder(){
    var loaders = [];
    for (var i=0; i<9; i++){
      loaders.push(
        fetch('images/'+(i+1)+'.png', {method:'GET'})
          .then(function(r){ return r.ok ? r.blob() : Promise.reject('no'); })
          .then(function(b){ return new Promise(function(res){ var fr=new FileReader(); fr.onload=function(){res(fr.result)}; fr.readAsDataURL(b); }); })
      );
    }
    return Promise.allSettled(loaders).then(function(results){
      var ok = results.every(function(r){ return r.status==='fulfilled'; });
      if (ok) IMAGES = results.map(function(r){ return r.value; });
    });
  }

  // ===== Puzzle =====
  var SOLVED = [
    5,3,4,6,7,8,9,1,2, 6,7,2,1,9,5,3,4,8, 1,9,8,3,4,2,5,6,7,
    8,5,9,7,6,1,4,2,3, 4,2,6,8,5,3,7,9,1, 7,1,3,9,2,4,8,5,6,
    9,6,1,5,3,7,2,8,4, 2,8,7,4,1,9,6,3,5, 3,4,5,2,8,6,1,7,9
  ];
  var PUZZLE = [
    5,3,0,0,7,0,0,0,0, 6,0,0,1,9,5,0,0,0, 0,9,8,0,0,0,0,6,0,
    8,0,0,0,6,0,0,0,3, 4,0,0,8,0,3,0,0,1, 7,0,0,0,2,0,0,0,6,
    0,6,0,0,0,0,2,8,0, 0,0,0,4,1,9,0,0,5, 0,0,0,0,8,0,0,7,9
  ];

  // ===== State =====
  var boardEl = document.getElementById('board');
  var picker = document.getElementById('picker');
  var statusEl = document.getElementById('status');
  var size = 9;
  var state = {cells: PUZZLE.slice(), given: new Set(), selectedIndex: -1, highlight: null};
  for (var gi=0; gi<PUZZLE.length; gi++){ if (PUZZLE[gi]>0) state.given.add(gi); }

  // ===== Square sizing (no aspect-ratio) =====
  function squareUp(){
    var cell = boardEl.querySelector('.cell');
    if(!cell){ requestAnimationFrame(squareUp); return; }
    var w = cell.clientWidth;
    if(w<=0){ requestAnimationFrame(squareUp); return; }
    boardEl.querySelectorAll('.cell').forEach(function(c){ c.style.height = w + 'px'; });
  }
  addEventListener('resize', squareUp);

  // ===== Board =====
  function buildBoard(){
    boardEl.innerHTML = '';
    // 強制 9 欄 grid（雙保險：行內樣式 + 這裡再寫一次）
    boardEl.style.display = 'grid';
    boardEl.style.gridTemplateColumns = 'repeat(9, minmax(34px, 1fr))';
    boardEl.style.gap = '0px';
    for (var r=0; r<size; r++){
      for (var c=0; c<size; c++){
        var i = r*size + c;
        var cell = document.createElement('div');
        cell.classList.add('cell');
        if ((Math.floor(r/3)+Math.floor(c/3))%2===1) cell.classList.add('alt');
        if ((c+1)%3===0) cell.classList.add('thick-right');
        if ((r+1)%3===0) cell.classList.add('thick-bottom');
        cell.dataset.index = i;
        cell.addEventListener('click', onCellClick);
        (function(ii){ cell.addEventListener('dblclick', function(){ tryPlace(ii,0); }); })(i);
        boardEl.appendChild(cell);
      }
    }
    render();
    squareUp();
    statusEl.textContent = '就緒';
  }

  // ===== Picker =====
  function buildPicker(){
    picker.innerHTML = '';
    picker.addEventListener('click', function(e){ e.stopPropagation(); });
    for (var n=1; n<=9; n++){
      (function(nLocal){
        var b = document.createElement('button');
        b.type='button'; b.className='pick'; b.dataset.value=nLocal; b.title=String(nLocal);
        var img = document.createElement('img'); img.src = IMAGES[nLocal-1]; img.alt = '選 '+nLocal; b.appendChild(img);
        b.addEventListener('click', function(e){
          e.stopPropagation();
          var i = state.selectedIndex; if (i>=0) tryPlace(i, nLocal);
          hidePicker(); setHighlight(nLocal);
        });
        picker.appendChild(b);
      })(n);
    }
  }
  function showPickerForCell(cell){
    var rect = cell.getBoundingClientRect();
    var top = window.scrollY + rect.bottom + 8;
    var left = window.scrollX + rect.left;
    picker.style.top = top+'px'; picker.style.left = left+'px';
    picker.classList.remove('hidden');
  }
  function hidePicker(){ picker.classList.add('hidden'); state.selectedIndex = -1; }
  document.addEventListener('click', function(e){ if (!picker.contains(e.target) && !e.target.classList.contains('cell')) hidePicker(); });

  // ===== Events =====
  function onCellClick(e){
    var i = Number(e.currentTarget.dataset.index);
    var v = state.cells[i];
    setHighlight(v);
    if (state.given.has(i)) return;
    state.selectedIndex = i;
    showPickerForCell(e.currentTarget);
  }
  function tryPlace(i, v){ if (!state.given.has(i)) { state.cells[i] = v; render(); } }
  document.addEventListener('keydown', function(e){
    if (state.selectedIndex<0) { if (e.key==='Escape') { hidePicker(); setHighlight(null); } return; }
    if (e.key>='1' && e.key<='9'){ var n = Number(e.key); tryPlace(state.selectedIndex, n); hidePicker(); setHighlight(n); }
    else if (e.key==='Backspace' || e.key==='Delete' || e.key==='0'){ tryPlace(state.selectedIndex, 0); hidePicker(); }
    else if (e.key==='Escape'){ hidePicker(); setHighlight(null); }
  });

  // ===== Highlight =====
  function setHighlight(v){ state.highlight = (v && v>0) ? v : null; render(); }

  // ===== Render =====
  function render(){
    var cells = boardEl.querySelectorAll('.cell');
    for (var i=0; i<cells.length; i++){
      var cell = cells[i];
      var v = state.cells[i];
      cell.classList.remove('given','error','ok','hl');
      cell.innerHTML = '';
      if (v>0){ var img = document.createElement('img'); img.src = IMAGES[v-1]; img.alt = '值 '+v; cell.appendChild(img); }
      if (state.given.has(i)) cell.classList.add('given');
      if (state.highlight && v===state.highlight) cell.classList.add('hl');
    }
    squareUp();
  }

  // ===== Validate =====
  function validate(){
    var errors = new Set();
    var rows = Array.from({length:9}, function(){ return new Map(); });
    var cols = Array.from({length:9}, function(){ return new Map(); });
    var box  = Array.from({length:9}, function(){ return new Map(); });
    for (var i=0;i<81;i++){
      var v = state.cells[i]; if (!v) continue;
      var r = Math.floor(i/9), c = i%9, b = Math.floor(r/3)*3 + Math.floor(c/3);
      var touch = function(m){ if (m.has(v)) { errors.add(i); errors.add(m.get(v)); } else m.set(v, i); };
      touch(rows[r]); touch(cols[c]); touch(box[b]);
    }
    var filled = state.cells.every(function(v){ return v>0; });
    if (filled){ for (var j=0;j<81;j++){ if (state.cells[j] !== SOLVED[j]) errors.add(j); } }
    boardEl.querySelectorAll('.cell').forEach(function(cell, i){
      cell.classList.toggle('error', errors.has(i));
      cell.classList.toggle('ok', !errors.has(i) && state.cells[i]>0);
    });
    if (filled && errors.size===0){ alert('恭喜完成！'); }
  }

  // ===== Controls =====
  document.getElementById('btnCheck').onclick = validate;
  document.getElementById('btnReset').onclick = function(){ setHighlight(null); state.cells = PUZZLE.slice(); render(); };

  // ===== Init =====
  try {
    buildBoard();
    buildPicker();
    autoLoadFromImagesFolder().then(function(){ buildPicker(); render(); });
  } catch(ex) {
    statusEl.textContent = '初始化失敗';
    errBar.textContent = '初始化失敗：' + (ex.message||ex);
    errBar.style.display='block';
  }
})();
</script>

<!-- Favicon auto-check（favicon.png / Favicon.png / favicon.ico） + 破快取 -->
<script>
(function(){
  var rels=['icon','shortcut icon','apple-touch-icon'];
  function setFav(href){
    for(var i=0;i<rels.length;i++){
      var link=document.querySelector('link[rel="'+rels[i]+'"]');
      if(!link){ link=document.createElement('link'); link.rel=rels[i]; document.head.appendChild(link); }
      link.href=href;
    }
  }
  var candidates=['favicon.png','Favicon.png','favicon.ico'];
  (async function(){
    for(var i=0;i<candidates.length;i++){
      try{ var r=await fetch(candidates[i],{method:'HEAD',cache:'no-store'}); if(r.ok){ setFav(candidates[i]+'?v='+(Date.now())); return; } }catch(e){}
    }
  })();
})();
</script>
</body>
</html>
